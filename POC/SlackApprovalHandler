@RestResource(urlMapping='/SlackApproval/*')
global with sharing class SlackApprovalHandler {

    @HttpPost
    global static void handleApproval() {
        System.debug(' SlackApprovalHandler invoked');

        try {
            RestRequest req = RestContext.request;
            String rawBody = req.requestBody.toString();
            System.debug(' Raw Slack Request Body: ' + rawBody);

            // Slack sends: payload=<urlencoded JSON>
            String payloadJson;

            if (rawBody.startsWith('payload=')) {
                payloadJson = rawBody.substring(8); // remove "payload="
                payloadJson = EncodingUtil.urlDecode(payloadJson, 'UTF-8');
                System.debug(' Decoded Slack Payload JSON: ' + payloadJson);
            } else {
                // If direct JSON (rare)
                payloadJson = rawBody;
                System.debug(' Direct JSON Payload received');
            }

            // Deserialize decoded JSON
            Map<String, Object> payload = (Map<String, Object>) JSON.deserializeUntyped(payloadJson);

            // Extract actions
            List<Object> actions = (List<Object>) payload.get('actions');
            System.debug(' Extracted actions: ' + actions);

            if (actions == null || actions.isEmpty()) {
                System.debug('No actions found in payload');
                RestContext.response.statusCode = 400;
                RestContext.response.responseBody = Blob.valueOf('{"text": "No actions found"}');
                return;
            }

            Map<String, Object> action = (Map<String, Object>) actions[0];
            String actionId = (String) action.get('action_id');   // approve_leave / reject_leave
            String leaveId = (String) action.get('value');       // record Id

            System.debug(' Action ID: ' + actionId);
            System.debug(' Leave Request ID: ' + leaveId);

            // Query Leave Request
            Leave_Request__c lr = [
                SELECT Id, Status__c
                FROM Leave_Request__c
                WHERE Id = :leaveId
                LIMIT 1
            ];

            System.debug(' Existing Status: ' + lr.Status__c);

            // Update based on button click
            if (actionId == 'approve_leave') {
                lr.Status__c = 'Approved';
                System.debug('✅ Marked as Approved');
            } else if (actionId == 'reject_leave') {
                lr.Status__c = 'Rejected';
                System.debug('❌ Marked as Rejected');
            } else {
                System.debug('️ Unknown action ID received: ' + actionId);
            }

            update lr;
            System.debug(' Updated Leave in Salesforce: ' + lr);

            // Respond to Slack
            RestContext.response.statusCode = 200;
            RestContext.response.addHeader('Content-Type', 'application/json');
            RestContext.response.responseBody = Blob.valueOf('{"text": "Leave ' + lr.Status__c + '!"}');
            System.debug(' Response sent back to Slack');

        } catch (Exception e) {
            System.debug(' ERROR in SlackApprovalHandler: ' + e.getMessage());
            RestContext.response.statusCode = 500;
            RestContext.response.responseBody = Blob.valueOf('{"text": "Server error"}');
        }
    }
}
